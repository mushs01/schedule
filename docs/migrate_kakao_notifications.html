<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤ ì•Œë¦¼ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #1557b0;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .log-entry {
            margin: 5px 0;
        }
        .log-success {
            color: #0f9d58;
        }
        .log-error {
            color: #d93025;
        }
        .log-info {
            color: #1a73e8;
        }
        .log-warning {
            color: #f9ab00;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background-color: #e6f4ea;
            color: #137333;
            display: block;
        }
        .status.error {
            background-color: #fce8e6;
            color: #c5221f;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ì¹´ì¹´ì˜¤ ì•Œë¦¼ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
        <div class="description">
            <p><strong>ì´ ë„êµ¬ëŠ” ê¸°ì¡´ ì¼ì •ì˜ ì¹´ì¹´ì˜¤ ì•Œë¦¼ ì„¤ì •ì„ ìƒˆë¡œìš´ ì‚¬ìš©ìë³„ ì•Œë¦¼ ì‹œìŠ¤í…œìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</strong></p>
            <p>ì—„ë§ˆì™€ ì•„ë¹ ê°€ ê°ê° ë¡œê·¸ì¸í•˜ì—¬ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:</p>
            <ul>
                <li><strong>ì—„ë§ˆ:</strong> ëª¨ë“  ì¼ì •ì˜ ì‹œì‘ ì•Œë¦¼ì´ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤</li>
                <li><strong>ì•„ë¹ :</strong> ëª¨ë“  ì•Œë¦¼ì´ ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤ (ì„ íƒì ìœ¼ë¡œ í™œì„±í™” ê°€ëŠ¥)</li>
            </ul>
            <p><strong>ì£¼ì˜:</strong> ì´ ì‘ì—…ì€ ì‹¤í–‰ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
        </div>
        
        <button id="migrateBtn" onclick="migrateData()">ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>
        <button id="testBtn" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        
        <div id="status" class="status"></div>
        
        <div class="log" id="logContainer">
            <div class="log-entry log-info">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Kakao SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>
    
    <script>
        let db;
        let currentUserId = null;
        let currentUserName = null;

        // Initialize Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                return true;
            } catch (error) {
                log(`âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
                return false;
            }
        }

        // Initialize Kakao
        function initKakao() {
            try {
                const KAKAO_APP_KEY = '870fe727e74ee5a06ea42e2b0a018006';
                if (!Kakao.isInitialized()) {
                    Kakao.init(KAKAO_APP_KEY);
                }
                log('âœ… Kakao SDK ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                
                // Check if user is logged in
                const accessToken = Kakao.Auth.getAccessToken();
                if (accessToken) {
                    log('âœ… ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ë¨', 'success');
                    getUserInfo();
                } else {
                    log('âš ï¸ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ì•±ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning');
                    // Auto login
                    kakaoLogin();
                }
            } catch (error) {
                log(`âŒ Kakao SDK ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // Kakao Login
        function kakaoLogin() {
            Kakao.Auth.login({
                success: function(authObj) {
                    log('âœ… ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„±ê³µ', 'success');
                    getUserInfo();
                },
                fail: function(err) {
                    log(`âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${err.error_description}`, 'error');
                }
            });
        }

        // Get User Info
        function getUserInfo() {
            Kakao.API.request({
                url: '/v2/user/me',
                success: function(response) {
                    currentUserId = response.id.toString();
                    log(`âœ… ì‚¬ìš©ì ID í™•ì¸: ${currentUserId}`, 'success');
                    
                    // Ask for user name
                    currentUserName = prompt('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì—„ë§ˆ, ì•„ë¹ ):', '');
                    if (currentUserName && currentUserName.trim()) {
                        currentUserName = currentUserName.trim();
                        log(`âœ… ì‚¬ìš©ì ì´ë¦„: ${currentUserName}`, 'success');
                    } else {
                        log('âš ï¸ ì‚¬ìš©ì ì´ë¦„ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'warning');
                    }
                },
                fail: function(error) {
                    log(`âŒ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${error.msg}`, 'error');
                }
            });
        }

        // Log function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('ko-KR')}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        // Show status
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Test connection
        async function testConnection() {
            log('ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
            
            if (!db) {
                log('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            if (!currentUserId) {
                log('âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }

            try {
                const snapshot = await db.collection('schedules').limit(5).get();
                log(`âœ… Firestore ì—°ê²° ì„±ê³µ (ì¼ì • ${snapshot.size}ê°œ í™•ì¸)`, 'success');
                showStatus(`ì—°ê²° ì„±ê³µ! ì‚¬ìš©ì: ${currentUserName} (ID: ${currentUserId})`, 'success');
            } catch (error) {
                log(`âŒ Firestore ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                showStatus('ì—°ê²° ì‹¤íŒ¨', 'error');
            }
        }

        // Migrate data
        async function migrateData() {
            if (!db) {
                log('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            if (!currentUserId) {
                log('âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }

            if (!confirm(`ì •ë§ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚¬ìš©ì: ${currentUserName} (ID: ${currentUserId})\n\nì´ ì‘ì—…ì€ ì‹¤í–‰ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            const migrateBtn = document.getElementById('migrateBtn');
            migrateBtn.disabled = true;
            migrateBtn.textContent = 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...';

            log('ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');
            log(`ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì: ${currentUserName} (ID: ${currentUserId})`, 'info');

            try {
                // Get all schedules
                const snapshot = await db.collection('schedules').get();
                log(`ğŸ“‹ ì´ ${snapshot.size}ê°œì˜ ì¼ì •ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤`, 'info');

                let updatedCount = 0;
                let skippedCount = 0;
                let errorCount = 0;

                // Determine default settings based on user name
                const isMom = currentUserName.includes('ì—„ë§ˆ');
                const defaultStartNotification = isMom;
                const defaultEndNotification = false;

                log(`âš™ï¸ ê¸°ë³¸ ì„¤ì •: ì‹œì‘ ì•Œë¦¼ ${defaultStartNotification ? 'ON' : 'OFF'}, ì¢…ë£Œ ì•Œë¦¼ ${defaultEndNotification ? 'ON' : 'OFF'}`, 'info');

                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    
                    // Check if this user already has notification settings
                    const kakaoNotifications = data.kakao_notifications || {};
                    
                    if (kakaoNotifications[currentUserId]) {
                        log(`â­ï¸  ê±´ë„ˆëœ€: "${data.title}" (ì´ë¯¸ ì„¤ì •ë¨)`, 'warning');
                        skippedCount++;
                        continue;
                    }

                    // Add user's notification settings
                    kakaoNotifications[currentUserId] = {
                        start: defaultStartNotification,
                        end: defaultEndNotification
                    };

                    try {
                        await db.collection('schedules').doc(doc.id).update({
                            kakao_notifications: kakaoNotifications
                        });
                        log(`âœ… ì—…ë°ì´íŠ¸: "${data.title}"`, 'success');
                        updatedCount++;
                    } catch (error) {
                        log(`âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: "${data.title}" - ${error.message}`, 'error');
                        errorCount++;
                    }
                }

                log('', 'info');
                log('=== ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ===', 'info');
                log(`âœ… ì—…ë°ì´íŠ¸: ${updatedCount}ê°œ`, 'success');
                log(`â­ï¸  ê±´ë„ˆëœ€: ${skippedCount}ê°œ`, 'warning');
                log(`âŒ ì‹¤íŒ¨: ${errorCount}ê°œ`, 'error');

                showStatus(`ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! (ì—…ë°ì´íŠ¸: ${updatedCount}, ê±´ë„ˆëœ€: ${skippedCount}, ì‹¤íŒ¨: ${errorCount})`, 'success');

            } catch (error) {
                log(`âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
                showStatus('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨', 'error');
            } finally {
                migrateBtn.disabled = false;
                migrateBtn.textContent = 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘';
            }
        }

        // Initialize on load
        window.onload = function() {
            if (initFirebase()) {
                initKakao();
            }
        };
    </script>
</body>
</html>

